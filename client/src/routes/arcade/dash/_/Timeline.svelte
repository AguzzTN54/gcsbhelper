<script lang="ts">
	import { onMount } from 'svelte';
	import dayjs, { type Dayjs } from '$lib/helpers/dateTime';
	import ScrollArea, { getTargetPosition, smoothScroll } from '$reusable/ScrollArea.svelte';
	import { getTimelineContents } from '$lib/data/timeline';
	import { arcadeRegion, initData } from '$lib/stores/app.svelte';

	let timelineW = $state(0);
	let timelineH = $state(0);
	const offset = 2;
	const calendar = $derived(getTimelineContents($initData, $arcadeRegion));

	interface DateList {
		month: string;
		dates: { date: number; day: string }[];
	}
	const getDateList = (): DateList[] => {
		const extendedStart = calendar.startrange.subtract(offset, 'day');
		const extendedEnd = calendar.endrange.add(offset, 'day');
		const grouped: DateList[] = [];
		let current = extendedStart;

		while (current.isBefore(extendedEnd) || current.isSame(extendedEnd, 'day')) {
			const monthKey = current.format('MMMM');
			let monthGroup = grouped.find((g) => g.month === monthKey);
			if (!monthGroup) {
				monthGroup = { month: monthKey, dates: [] };
				grouped.push(monthGroup);
			}

			monthGroup.dates.push({
				date: current.date(),
				day: current.format('dd')
			});
			current = current.add(1, 'day');
		}

		return grouped;
	};

	let timeNow = $state(dayjs(new Date()));
	setInterval(() => {
		timeNow = dayjs(new Date());
	}, 1000);

	const timeNowPosition = (timenow: Dayjs): number => {
		const now = dayjs(timenow);
		const daysDiff = now.diff(calendar.startrange.startOf('day'), 'day');
		const secondsInDay = 24 * 60 * 60;
		const secondsToday = now.diff(now.startOf('day'), 'second');
		const fractionToday = secondsToday / secondsInDay;
		return daysDiff + fractionToday;
	};

	const scroll = () => {
		const { x: xpos, y } = getTargetPosition('timeline', '#nowindicator');
		const x = xpos - (timelineW / 7) * 2.75;
		const targetPosition = { x, y };
		smoothScroll({ id: 'timeline', targetPosition });
	};
	onMount(() => {
		const t = setTimeout(() => {
			scroll();
			clearTimeout(t);
		}, 500);
	});
</script>

<div
	class="size-full overflow-hidden mt-2 min-h-[calc(var(--tm-height)+1.5rem)] sm:min-h-auto"
	bind:clientWidth={timelineW}
	style="--tm-width:{timelineW}px;--tm-height:{timelineH}px;--dtw:calc(var(--tm-width)/7)"
>
	<ScrollArea horizontal id="timeline">
		<div
			class="relative h-[98%] w-0.5 bg-red-500 z-21 flex"
			style="transform: translateX(
				calc(var(--dtw)/2
				+ var(--dtw)*{offset}
				+ var(--dtw)*{timeNowPosition(timeNow)})
			);"
		>
			<span
				id="nowindicator"
				class="inline-block text-xs bg-red-500 py-1 px-2 rounded-full leading-[110%] text-white mt-auto mb-1 -translate-x-1/2"
			>
				{timeNow.format('HH:mm:ss')}
			</span>
		</div>

		<div class="absolute top-0 left-0 h-full min-h-fit" id="timeline-grid">
			<div class="h-full absolute flex top-0 left-0 z-10">
				{#each getDateList() as { dates, month }}
					<div class="flex h-full">
						<div class="w-0 sticky left-0 top-0">
							<span
								class="h-fit inline-block text-sm px-2 bg-purple-200 text-purple-800 font-bold -translate-y-1/5"
							>
								{month}
							</span>
						</div>
						{#each dates as { date, day }}
							<div class="w-[var(--dtw)] flex flex-col">
								<div class="head flex flex-col text-center text-sm">
									<span class="text-gray-600 font-light">{day}</span>
									<span class="font-semibold inline-block mt-0.5"> {date} </span>
								</div>
								<span class="line h-[calc(100%-3rem)] bg-gray-400 w-[1px] mx-auto"> </span>
							</div>
						{/each}
					</div>
				{/each}
			</div>

			<!-- Strip -->
			<div
				class="mt-12 pb-5 text-sm translate-x-[calc(var(--dtw)/2)] relative z-20"
				bind:clientHeight={timelineH}
			>
				{#each calendar.timeline as itemperrow (itemperrow)}
					{@const { startdate } = itemperrow[0]}
					<div
						style="--offset:{dayjs(startdate).diff(calendar.startrange, 'day', true) + offset}"
						class="my-1 ml-[calc(var(--dtw)*var(--offset))] flex"
					>
						{#each itemperrow as { enddate, startdate, title, type, image }, i (title)}
							<button
								style="--w:{dayjs(enddate).diff(startdate, 'day', true)};
									--ml:{dayjs(startdate).diff(itemperrow[i - 1]?.enddate || startdate, 'day', true)}"
								class="w-[calc(var(--w)*var(--dtw))] ml-[calc(var(--dtw)*var(--ml))] bg-indigo-200 text-indigo-900 rounded-lg relative inline-flex justify-between {type}"
							>
								<span class="sticky -left-6 top-0 z-1 my-2 inline-block px-4 rounded-full">
									{title}
								</span>
								{#if image}
									<div class="flex w-25 h-full overflow-hidden sticky right-5 top-0 rounded-r-lg">
										<img src={image} alt="Arcade" class="absolute top-0 right-0 -translate-y-2/5" />
									</div>
								{/if}
							</button>
						{/each}
					</div>
				{/each}
			</div>
		</div>
	</ScrollArea>
</div>

<style lang="postcss">
	@import 'tailwindcss/theme' theme(reference);
	button {
		&.wmp {
			span {
				@apply bg-[#202124];
			}
			@apply text-white/80;
			background-image: linear-gradient(to left, #1a6260, #202124);
		}
		&.game,
		&.special {
			span {
				@apply bg-[#202124];
			}
			@apply text-white/80;
			background-image: linear-gradient(to left, #162a43, #202124);
		}
		&.trivia {
			span {
				@apply bg-[#202124];
			}
			@apply text-white/80;
			background-image: linear-gradient(to left, #51364b, #202124);
		}
		&.expected {
			span {
				@apply bg-[#202124];
			}
			@apply text-white/80 bg-[#202124];
		}
	}
</style>
